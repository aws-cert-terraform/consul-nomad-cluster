{"ignition":{"config":{},"security":{"tls":{}},"timeouts":{},"version":"2.2.0"},"networkd":{},"passwd":{},"storage":{"files":[{"filesystem":"root","path":"/opt/start","contents":{"source":"data:,%23!%2Fbin%2Fbash%0Ainstall%20-m%20740%20%2Fdev%2Fnull%20%2Fopt%2Fcraft_environment%0Amkdir%20%2Fopt%2Fnomad.d%0A%0ACONSUL_IP%3D%24(curl%20-s%20http%3A%2F%2F169.254.169.254%2Fmetadata%2Fv1%2Finterfaces%2Fpublic%2F0%2Fipv4%2Faddress)%0A%0Aeval%20%22cat%20%3C%3CEOF%0ACONSUL_IP%3D%24%7BCONSUL_IP%7D%0ADO_TOKEN%3D%22af7d46ed4971aa6481370573596910a6c99c868452f4ed4d26883b5696666d99%22%0AEOF%22%20%3E%20%2Fopt%2Fcraft_environment%0A%0Aeval%20%22cat%20%3C%3CEOF%0Alog_level%20%3D%20%5C%22DEBUG%5C%22%0Abind_addr%20%3D%20%5C%220.0.0.0%5C%22%0Adata_dir%20%3D%20%5C%22%2Ftmp%2Fserver1%5C%22%0A%0A%23%20advertise%20%7B%0A%23%20%20%20rpc%20%3D%20%5C%22%24%7BCONSUL_IP%7D%3A4647%5C%22%0A%23%20%7D%0A%0Aserver%20%7B%0A%20%20enabled%20%3D%20true%0A%20%20bootstrap_expect%20%3D%202%0A%7D%0A%0AEOF%22%20%3E%20%2Fopt%2Fnomad.d%2Fserver.hcl%0A%0A%20%20%20%20%20%20%20%20%20%20%23%20Client%0Aeval%20%22cat%20%3C%3CEOF%0Adatacenter%20%3D%20%5C%22dc1%5C%22%0Adata_dir%20%20%20%3D%20%5C%22%2Fetc%2Fnomad.d%5C%22%0A%0Aclient%20%7B%0A%20%20enabled%20%3D%20true%0A%7D%0A%0AEOF%22%20%3E%20%2Fopt%2Fnomad.d%2Fclient.hcl%0A%0Aecho%20%22Installing%20Nomad...%22%0ANOMAD_VERSION%3D0.8.6%0Acd%20%2Ftmp%2F%0Acurl%20-sSL%20https%3A%2F%2Freleases.hashicorp.com%2Fnomad%2F%24%7BNOMAD_VERSION%7D%2Fnomad_%24%7BNOMAD_VERSION%7D_linux_amd64.zip%20-o%20nomad.zip%0Aunzip%20nomad.zip%0Ainstall%20nomad%20%2Fopt%2Fnomad%0Amkdir%20-p%20%2Fetc%2Fnomad.d%0Achmod%20a%2Bw%20%2Fetc%2Fnomad.d%0A","verification":{}},"mode":480}]},"systemd":{"units":[{"contents":"[Unit]\nDescription=Set up cores server\nRequires=docker.service network-online.target\nAfter=docker.service network-online.target \n\n[Service]\nType=oneshot\nEnvironment=DOCKER_IMAGE=busybox\nEnvironment=DOCKER_NAME=%p\nExecStart=/opt/start\n# ExecStart=/usr/bin/docker run --rm --name $DOCKER_NAME cat /opt/craft_environment\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"write-environment.service"},{"contents":"[Unit]\nDescription=Consul Server\nRequires=docker.service network-online.target write-environment.service\nAfter=docker.service network-online.target write-environment.service\n\n[Service]\nEnvironment=DOCKER_IMAGE=consul\nEnvironment=DOCKER_NAME=%p\nEnvironmentFile=/opt/craft_environment\n\nType=service\nRestart=always\nRestartSec=60\nStartLimitInterval=0\nTimeoutStartSec=0\nExecStart=/usr/bin/docker run --rm --name $DOCKER_NAME \\\n    -v /data/consul:/data \\\n    --net=host \\\n    -e CONSUL_IP=${CONSUL_IP} \\\n    -e DO_TOKEN=${DO_TOKEN} \\\n    $DOCKER_IMAGE agent -server -ui -bootstrap-expect=2 -client=0.0.0.0 \\\n        -advertise=${CONSUL_IP} -retry-join=\"provider=digitalocean region=nyc3 tag_name=consul api_token=${DO_TOKEN}\"\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"consul.service"},{"contents":"[Unit]\nDescription=Nomad client\nWants=network-online.target write-environment.service\nAfter=network-online.target write-environment.service\n\n[Service]\nEnvironmentFile=/opt/craft_environment\nExecStart=/opt/nomad agent -config /opt/nomad.d/server.hcl \nRestart=always\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"nomad.service"},{"contents":"[Unit]\nDescription=Nomad client\nWants=network-online.target write-environment.service\nAfter=network-online.target write-environment.service\n\n[Service]\nEnvironmentFile=/opt/craft_environment\nExecStart=/opt/nomad agent -config /opt/nomad.d/client.hcl \nRestart=always\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"nomad-agent.service"}]}}